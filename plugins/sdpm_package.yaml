#
# Sdpm wrapper pluggin for developing cross-repo packages
#

props:

  # -- Odds are, these are private variables
  _platform_server:
    linux: /mnt/isilon2
    windows: //isilon2

  _platform_arch:
    linux: x86_64-Linux
    windows: AMD64-Windows

  _sdpm_archive:
    linux: sdpm.tar.gz
    windows: sdpm.zip

  _sdpm_deploy_location: "{_platform_server}/s3d/resources/sw/packages/{package}"

  _dev_build: "{source_dir}/dev/dist/{_platform_arch}"

  # -- This is where the overloading will come in.
  # Each sdpm supported build file will have to create
  # their own sdpm.rc string
  sdpm_rc_file: |
    import os
    class SdpmRc(SdpmRcBase):
      """ Default SDPM wrapper for fbuild """
      def pathEnv(self):
        return { "PATH": [self._path]}


#
# Alas, sdpm builds dev within source. No fun, but that's the
# way the cookie crumbles.
#
func__sdpm_dev_build():
  - ":DEL {source_dir}/dev"
  - ":MKDIR -s {_dev_build}"
  - ":COPY -f {build_dir}/* {_dev_build} -x launch.json"
  - ":WRITE {sdpm_rc_file} {_dev_build}/sdpm.rc"


func__sdpm_clean_dev_build():
  - ":DEL {source_dir}/dev"


#
# Deployment of an sdpm package is another story completely.
#
func__sdpm_deploy_simple(sdpm_version, sdpm_fix_number):
  - ":SET {_sdpm_deploy_location}/{sdpm_version}/{sdpm_fix_number}/{_platform_arch} deployment_loc"
  - ":MKDIR -s {deployment_loc}"
  - ":CD {build_dir}" # Should already be there but just in case
  - windows: 7z a -r ../{sdpm_archive} -w ./* # TODO: Get a python command for this
    unix: tar -cvzf ../{sdpm_archive} ./*
  - ":COPY -f {build_dir}/* {deployment_loc}"
  - ":MOVE -f ../{sdpm_archive} {deployment_loc}"
  - ":WRITE {sdpm_rc_file} {deployment_loc}/sdpm.rc"
  - ":CD --pop" # Go back to where we were


build:

  pre_build:
    - ['--sdpm-clean', ":FUNC sdpm_clean_dev_build()"]

  #
  # -- Overload the post build process to make an sdpm build if the argument
  # is supplied
  #
  post_build:
    - ["--sdpm", ":FUNC sdpm_dev_build()"]


deploy:

  #
  # We need to be able to pack up the sdpm packages
  #
  local_required:
    windows:
      - 7z
    unix:
      - tar
